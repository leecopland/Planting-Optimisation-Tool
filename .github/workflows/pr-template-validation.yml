name: Validate Pull Request Template

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const errors = [];

            function section(title) {
              const regex = new RegExp(`## ${title}[\\s\\S]*?(?=\\n## |$)`, "m");
              const match = body.match(regex);
              return match ? match[0] : null;
            }

            function stripComments(text) {
              return text.replace(/<!--[\s\S]*?-->/g, "").trim();
            }

            function requireSection(title) {
              if (!section(title)) {
                errors.push(`Missing section: ${title}`);
              }
            }

            function requireText(title, minLength = 10) {
              const sec = section(title);
              if (!sec) return;
              const content = stripComments(sec);
              if (content.length < minLength) {
                errors.push(`${title}: must contain meaningful text`);
              }
            }

            function checkedCount(sec) {
              return (sec.match(/- \[x\]/gi) || []).length;
            }

            function requireAtLeastOneChecked(title) {
              const sec = section(title);
              if (!sec || checkedCount(sec) === 0) {
                errors.push(`${title}: at least one option must be checked`);
              }
            }

            function requireAllChecked(title) {
              const sec = section(title);
              if (!sec) return;
              const total = (sec.match(/- \[[ x]\]/gi) || []).length;
              if (checkedCount(sec) !== total) {
                errors.push(`${title}: all checklist items must be checked`);
              }
            }

            function requireOtherText(title) {
              const sec = section(title);
              if (!sec) return;
              const otherChecked = /- \[x\] Other/i.test(sec);
              if (!otherChecked) return;

              const lines = stripComments(sec).split("\n");
              const otherLine = lines.find(l => /Other/i.test(l));
              if (!otherLine || !/:\s*\S+/.test(otherLine)) {
                errors.push(`${title}: 'Other' is checked but not described`);
              }
            }

            // Required sections
            requireSection("Description");
            requireSection("Related Issue / Task");
            requireSection("Team / Area");
            requireSection("Type of Change");
            requireSection("Checklist");

            // Text enforcement
            requireText("Description", 20);
            requireText("Related Issue / Task", 5);

            // Checkbox rules
            requireAtLeastOneChecked("Team / Area");
            requireOtherText("Team / Area");

            requireAtLeastOneChecked("Type of Change");
            requireOtherText("Type of Change");

            requireAllChecked("Checklist");

            if (errors.length > 0) {
              core.setFailed(
                "Pull request template validation failed:\n\n" +
                errors.map(e => `- ${e}`).join("\n")
              );
            }
